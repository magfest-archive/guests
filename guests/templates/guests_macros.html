{% import 'macros.html' as macros %}

{% macro inventory_image(item=None, name='image', class='') -%}
  <img src="{{ guest_merch.inventory_url(item.id, name) }}" class="{{ class }}"/>
{%- endmacro %}

{% macro inventory_form_file(type, item=None, index='', suffix='', is_required=False) -%}
  {% set file_attr = type ~ '-' ~ index if index|string else type %}
  {% set filename_attr = file_attr ~ '_filename' %}
  {% set download_filename_attr = file_attr ~ '_download_filename' %}
  {% set content_type_attr = file_attr ~ '_content_type' %}
  {% set has_file = item and filename_attr in item and item[filename_attr] %}
  <div class="well well-sm well-form-control inventory-file inventory-file-{{ type }}">
    <input type="hidden" class="download_filename" name="inventory_{{ download_filename_attr }}{{ suffix }}" value="{{ item[download_filename_attr] }}" />
    <input type="hidden" class="filename" name="inventory_{{ filename_attr }}{{ suffix }}" value="{{ item[filename_attr] }}" />
    <input type="hidden" class="content_type" name="inventory_{{ content_type_attr }}{{ suffix }}" value="{{ item[content_type_attr] }}" />
    {% if has_file and caller %}
      {{ caller(file_attr, filename_attr, download_filename_attr, content_type_attr) }}
    {% endif %}
    <input type="file" class="file" name="inventory_{{ file_attr }}{{ suffix }}" {% if is_required and not has_file %}required{% endif %} />
  </div>
{%- endmacro %}

{% macro inventory_form_audio(item=None, index='', suffix='', is_required=False) -%}
  {% call(file_attr, filename_attr, download_filename_attr, content_type_attr) inventory_form_file('audio', item, index, suffix, is_required) %}
    <button class="close remove_file pull-right current-file"><span aria-hidden="true">&times;</span></button>
    <div class="current-file">
      <p>{{ item[download_filename_attr] }}</p>
      <audio controls>
        <source src="{{ guest_merch.inventory_url(item.id, file_attr) }}" type="{{ item[content_type_attr] }}">
        <a href="{{ guest_merch.inventory_url(item.id, file_attr) }}">Click to download audio file</a>
      </audio>
    </div>
    <span class="current-file">Update file:</span>
  {% endcall %}
{%- endmacro %}

{% macro inventory_form_image(item=None, index='', suffix='', is_required=True) -%}
  {% call(file_attr, filename_attr, download_filename_attr, content_type_attr) inventory_form_file('image', item, index, suffix, is_required) %}
    {{ inventory_image(item, file_attr, 'current-file') }}
    <span class="current-file">Update image:</span>
  {% endcall %}
{%- endmacro %}

{% macro base_inventory_form(type, show_quantity=True, item=None, suffix='') -%}
  {%- set label = c.MERCH_TYPES[type] -%}
  <div class="panel panel-default inventory-item">
    <div class="panel-body">
      <h4>
        {{ label }}
        <button class="btn btn-sm btn-danger remove_inventory pull-right"><span class="glyphicon glyphicon-remove"></span></button>
      </h4>
      <input type="hidden" name="inventory_type{{ suffix }}" value="{{ type }}"/>
      <input type="hidden" name="inventory_id{{ suffix }}" {% if item and item.id %}value="{{ item.id }}"{% endif %}/>
      <div class="form-group">
        <label class="col-sm-3 control-label">Name</label>
        <div class="col-sm-6">
          <input class="form-control" type="text" name="inventory_name{{ suffix }}" value="{{ item.name }}" placeholder="{{ label }} Name" required />
        </div>
      </div>
      <div class="form-group">
        <label class="col-sm-3 control-label">Price</label>
        <div class="col-sm-6">
          <div class="input-group">
            <span class="input-group-addon">$</span>
            <input class="form-control" type="text" name="inventory_price{{ suffix }}" value="{{ item.price }}" placeholder="How much do you want to charge?" required />
          </div>
        </div>
        <div class="clearfix"></div>
        <p class="help-block col-sm-offset-3 col-sm-9">
          Please remember to include sales tax and square fees into your pricing,
          as we do not calculate them at the time of sale.
          (Sales Tax: 6%; Square Fees: <a href="https://squareup.com/pricing">https://squareup.com/pricing</a>)
        </p>
      </div>
      {% if show_quantity %}
        <div class="form-group">
          <label class="col-sm-3 control-label">Quantity</label>
          <div class="col-sm-6">
            <input class="form-control" type="number" name="inventory_quantity{{ suffix }}" value="{{ item.quantity }}" placeholder="How many do you have for sale?" required />
          </div>
        </div>
      {% endif %}
      <div class="form-group">
        <label class="col-sm-3 control-label">Promo Picture</label>
        <div class="col-sm-6">
          {{ inventory_form_image(item, suffix=suffix) }}
        </div>
        <div class="clearfix"></div>
        <p class="help-block col-sm-offset-3 col-sm-9">
          Images should be square, and must be in {{ c.ALLOWED_INVENTORY_IMAGE_EXTENSIONS|comma_join('or') }}
          format. We want a high resolution image of your merch, not a camera
          phone picture of it. We'll print them out, so upload a good
          resolution! ;)
        </p>
      </div>
      {% if caller %}{{ caller() }}{% endif %}
    </div>
  </div>
{%- endmacro %}

{% macro apparel_inventory_form(type, varieties_opts, cut_opts, sizes_opts, item=None, suffix='') -%}
  {% call base_inventory_form(type, show_quantity=False, item=item, suffix=suffix) %}
    {%- set step_count = varieties_opts|length -%}
    {%- set col_size = ([4, (12 / step_count)|round(0, 'floor')|int] | sort)[-1] -%}
    {% for variety_value, variety_label in varieties_opts %}
      <div class="col-sm-{{ col_size }} col-variety">
        <h5>{{ variety_label }}</h5>
        <div class="checkbox form-one_size">
          {%- set one_size_attr = 'quantity-' ~ variety_value ~ '-0-0' -%}
          {%- set is_one_size = item[one_size_attr] if item and one_size_attr in item else False -%}
          <label><input type="checkbox" class="one_size" {% if is_one_size %}checked{% endif %}> One size only</label>
          <input type="number" name="inventory_{{ one_size_attr }}{{ suffix }}" class="one_size_quantity" {% if is_one_size %}value="{{ item[one_size_attr] }}"{% endif %} required/>
        </div>
        <div class="clearfix"></div>
        <div class="panel panel-default panel-sizes">
          <table class="table table-condensed">
            <tbody>
              {% for cut_value, cut_label in cut_opts %}
                {% for size_value, size_label in sizes_opts %}
                  <tr>
                    <td>
                      {%- set quantity_attr = 'quantity-' ~ variety_value ~ '-' ~ cut_value ~ '-' ~ size_value -%}
                      {%- set has_quantity = item[quantity_attr] if item and quantity_attr in item else False -%}
                      {{ size_label }}{% if cut_label|trim %} - {{ cut_label }}{% endif %}
                      <input type="number" name="inventory_{{ quantity_attr }}{{ suffix }}" {% if has_quantity %}value="{{ item[quantity_attr] }}"{% endif %}/>
                    </td>
                  </tr>
                {% endfor %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  {% endcall %}
{%- endmacro %}

{% macro cd_inventory_form(type, item=None, suffix='') -%}
  {% call base_inventory_form(type, item=item, suffix=suffix) %}
    <div class="form-group">
      <label class="col-sm-3 control-label">Sample Tracks</label>
      <div class="col-sm-6">
        {% for index in range(0, 3) %}
          {{ inventory_form_audio(item, loop.index0, suffix) }}
        {% endfor %}
      </div>
      <div class="clearfix"></div>
      <p class="help-block col-sm-offset-3 col-sm-9">
        You may optionally upload sample tracks from the album for us to make
        available for <b>listening at the table</b>! Audio files must be in
        {{ c.ALLOWED_INVENTORY_AUDIO_EXTENSIONS|comma_join('or') }} format â€“
        mp3 and m4a are preferable.
      </p>
    </div>
  {% endcall %}
{%- endmacro %}

{% macro inventory_form(type, item=None, suffix='') -%}
  {% set type = type|int %}
  {% if type == c.TSHIRT -%}
    {{ apparel_inventory_form(c.TSHIRT, c.TSHIRT_VARIETIES_OPTS, c.TSHIRT_CUT_OPTS, c.TSHIRT_SIZES_OPTS, item=item, suffix=suffix) }}
  {% elif type == c.APPAREL %}
    {{ apparel_inventory_form(c.APPAREL, c.APPAREL_VARIETIES_OPTS, c.APPAREL_CUT_OPTS, c.APPAREL_SIZES_OPTS, item=item, suffix=suffix) }}
  {% elif type == c.CD %}
    {{ cd_inventory_form(c.CD, item=item, suffix=suffix) }}
  {% else %}
    {{ base_inventory_form(type, item=item, suffix=suffix) }}
  {% endif %}
{%- endmacro %}
