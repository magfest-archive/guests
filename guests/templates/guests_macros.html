{% import 'macros.html' as macros %}

{% macro inventory_image(item=None, name='image', class='') -%}
  {%- set inventory_url = guest_merch.inventory_url(item.id, name) -%}
  <a href="{{ inventory_url }}" target="_blank"><img src="{{ inventory_url }}" class="{{ class }}"/></a>
{%- endmacro %}

{% macro inventory_audio(item=None, name='audio', class='') -%}
  {%- set inventory_url = guest_merch.inventory_url(item.id, name) -%}
  {% set content_type_attr = name ~ '_content_type' %}
  {% set download_filename_attr = name ~ '_download_filename' %}
  <audio controls class="{{ class }}" title="{{ item[download_filename_attr] }}">
    <source src="{{ inventory_url }}" type="{{ item[content_type_attr] }}">
    <a href="{{ inventory_url }}">Click to download audio file</a>
  </audio>
{%- endmacro %}

{% macro inventory_form_file(type, item=None, index='', suffix='', is_required=False) -%}
  {%- set type = type|lower -%}
  {%- set file_attr = type ~ '-' ~ index if index|string else type -%}
  {%- set filename_attr = file_attr ~ '_filename' -%}
  {%- set download_filename_attr = file_attr ~ '_download_filename' -%}
  {%- set content_type_attr = file_attr ~ '_content_type' -%}
  {%- set has_file = item and filename_attr in item and item[filename_attr] -%}
  <div class="well well-sm well-form-control inventory-file inventory-file-{{ type }}">
    <input type="hidden" class="download_filename" name="inventory_{{ download_filename_attr }}{{ suffix }}" value="{{ item[download_filename_attr] }}" />
    <input type="hidden" class="filename" name="inventory_{{ filename_attr }}{{ suffix }}" value="{{ item[filename_attr] }}" />
    <input type="hidden" class="content_type" name="inventory_{{ content_type_attr }}{{ suffix }}" value="{{ item[content_type_attr] }}" />
    {% if has_file and caller %}
      {{ caller(file_attr, filename_attr, download_filename_attr, content_type_attr) }}
    {% endif %}
    {%- set allowed = c['ALLOWED_INVENTORY_' ~ type|upper ~ '_EXTENSIONS'] -%}
    <input
      type="file"
      class="file"
      name="inventory_{{ file_attr }}{{ suffix }}"
      {%- if allowed %} accept="{{ type }}/{{ allowed|join(', ' ~ type ~ '/') }}, {{ type }}/x-{{ allowed|join(', ' ~ type ~ '/x-') }}"{% endif -%}
      {%- if is_required and not has_file %} required {% endif -%} />
  </div>
{%- endmacro %}

{% macro inventory_form_audio(item=None, index='', suffix='', is_required=False) -%}
  {% call(file_attr, filename_attr, download_filename_attr, content_type_attr) inventory_form_file('audio', item, index, suffix, is_required) %}
    <button class="close remove_file pull-right current-file" type="button"><span aria-hidden="true">&times;</span></button>
    <div class="current-file">
      <p>{{ item[download_filename_attr] }}</p>
      {{ inventory_audio(item, file_attr) }}
    </div>
    <span class="current-file">Update file:</span>
  {% endcall %}
{%- endmacro %}

{% macro inventory_form_image(item=None, index='', suffix='', is_required=True) -%}
  {% call(file_attr, filename_attr, download_filename_attr, content_type_attr) inventory_form_file('image', item, index, suffix, is_required) %}
    {{ inventory_image(item, file_attr, 'current-file') }}
    <span class="current-file">Update image:</span>
  {% endcall %}
{%- endmacro %}

{% macro base_inventory_form(type, show_quantity=True, item=None, suffix='') -%}
  {%- set label = c.MERCH_TYPES[type] -%}
  <div class="panel panel-default inventory-item">
    <div class="panel-body">
      <h4>
        {{ label }}
        <button class="btn btn-sm btn-danger remove_inventory pull-right" type="button"><span class="glyphicon glyphicon-remove"></span></button>
      </h4>
      <input type="hidden" name="inventory_type{{ suffix }}" value="{{ type }}"/>
      <input type="hidden" name="inventory_id{{ suffix }}" {% if item and item.id %}value="{{ item.id }}"{% endif %}/>
      <div class="form-group">
        <label class="col-sm-3 control-label">Name</label>
        <div class="col-sm-6">
          <input class="form-control" type="text" name="inventory_name{{ suffix }}" value="{{ item.name }}" placeholder="{{ label }} Name" required />
        </div>
      </div>
      <div class="form-group">
        <label class="col-sm-3 control-label">Price</label>
        <div class="col-sm-6">
          <div class="input-group">
            <span class="input-group-addon">$</span>
            <input class="form-control" type="number" step="any" name="inventory_price{{ suffix }}" value="{{ item.price }}" placeholder="How much do you want to charge?" min="0" required />
          </div>
        </div>
        <div class="clearfix"></div>
        <p class="help-block col-sm-offset-3 col-sm-9">
          Please remember to include sales tax and square fees into your pricing,
          as we do not calculate them at the time of sale.
          (Sales Tax: 6%; Square Fees: <a href="https://squareup.com/pricing">https://squareup.com/pricing</a>)
        </p>
      </div>
      {% if show_quantity %}
        <div class="form-group">
          <label class="col-sm-3 control-label">Quantity</label>
          <div class="col-sm-6">
            <input class="form-control" type="number" name="inventory_quantity{{ suffix }}" value="{{ item.quantity }}" placeholder="How many do you have for sale?" min="0" required />
          </div>
        </div>
      {% endif %}
      <div class="form-group">
        <label class="col-sm-3 control-label">Promo Picture</label>
        <div class="col-sm-6">
          {{ inventory_form_image(item, suffix=suffix) }}
        </div>
        <div class="clearfix"></div>
        <p class="help-block col-sm-offset-3 col-sm-9">
          Images should be square, and must be in {{ c.ALLOWED_INVENTORY_IMAGE_EXTENSIONS|comma_join('or') }}
          format. We want a high resolution image of your merch, not a camera
          phone picture of it. We'll print them out, so upload a good
          resolution! ;)
        </p>
      </div>
      {% if caller %}{{ caller() }}{% endif %}
    </div>
  </div>
{%- endmacro %}

{% macro apparel_inventory_form(type, item=None, suffix='') -%}
  {%- set varieties_opts, cuts_opts, sizes_opts = guest_merch.item_subcategories_opts(type) -%}
  {% call base_inventory_form(type, show_quantity=False, item=item, suffix=suffix) %}
    {%- set step_count = varieties_opts|length -%}
    {%- set col_size = ([4, (12 / step_count)|round(0, 'floor')|int] | sort)[-1] -%}
    {% for variety_value, variety_label in varieties_opts %}
      <div class="col-sm-{{ col_size }} col-variety">
        <h5>{{ variety_label }}</h5>
        <div class="checkbox form-one_size">
          {%- set one_size_attr = 'quantity-' ~ variety_value ~ '-0-0' -%}
          {%- set is_one_size = item[one_size_attr] if item and one_size_attr in item else False -%}
          <label><input type="checkbox" class="one_size" {% if is_one_size %}checked{% endif %}> One size only</label>
          <input type="number" name="inventory_{{ one_size_attr }}{{ suffix }}" class="one_size_quantity" {% if is_one_size %}value="{{ item[one_size_attr] }}"{% endif %} min="0" required/>
        </div>
        <div class="clearfix"></div>
        <div class="panel panel-default panel-sizes">
          <table class="table table-condensed">
            <tbody>
              {% for cut_value, cut_label in cuts_opts %}
                {% for size_value, size_label in sizes_opts %}
                  <tr>
                    <td>
                      {%- set quantity_attr = 'quantity-' ~ variety_value ~ '-' ~ cut_value ~ '-' ~ size_value -%}
                      {%- set has_quantity = item[quantity_attr] if item and quantity_attr in item else False -%}
                      {% if cut_label|trim %}{{ cut_label }} - {% endif %}{{ size_label }}
                      <input type="number" name="inventory_{{ quantity_attr }}{{ suffix }}" {% if has_quantity %}value="{{ item[quantity_attr] }}"{% endif %} min="0"/>
                    </td>
                  </tr>
                {% endfor %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  {% endcall %}
{%- endmacro %}

{% macro cd_inventory_form(type, item=None, suffix='') -%}
  {% call base_inventory_form(type, item=item, suffix=suffix) %}
    <div class="form-group">
      <label class="col-sm-3 control-label">Sample Tracks</label>
      <div class="col-sm-6">
        {% for index in range(0, 3) %}
          {{ inventory_form_audio(item, loop.index0, suffix) }}
        {% endfor %}
      </div>
      <div class="clearfix"></div>
      <p class="help-block col-sm-offset-3 col-sm-9">
        You may optionally upload sample tracks from the album for us to make
        available for <b>listening at the table</b>! Audio files must be in
        {{ c.ALLOWED_INVENTORY_AUDIO_EXTENSIONS|comma_join('or') }} format â€“
        mp3 and m4a are preferable.
      </p>
    </div>
  {% endcall %}
{%- endmacro %}

{% macro inventory_form(type, item=None, suffix='') -%}
  {% set type = type|int %}
  {% if type in [c.TSHIRT, c.APPAREL] -%}
    {{ apparel_inventory_form(type, item=item, suffix=suffix) }}
  {% elif type == c.CD %}
    {{ cd_inventory_form(type, item=item, suffix=suffix) }}
  {% else %}
    {{ base_inventory_form(type, item=item, suffix=suffix) }}
  {% endif %}
{%- endmacro %}

{% macro inventory_table_data_apparel_quantity(item) -%}
  {%- set varieties_opts, cuts_opts, sizes_opts = guest_merch.item_subcategories_opts(item.type) -%}
  {%- set total_quantity = guest_merch.total_quantity(item) -%}
  {%- set line_items = guest_merch.line_items(item) -%}
  <td class="inventory-item-quantity" data-order="{{ total_quantity }}">
    <dl>
      {% for line_item in line_items %}
        <div class="line-item">
          <dt>{{ guest_merch.line_item_to_string(item, line_item) }}</dt>
          <dd>{{ item[line_item] }}</dd>
        </div>
      {% endfor %}
      {% if line_items|length > 1 %}
        <hr>
        <div class="line-item">
          <dt>Total</dt>
          <dd>{{ total_quantity }}</dd>
        </div>
      {% endif %}
    </dl>
  </td>
{%- endmacro %}

{% macro inventory_table_data_cd_name(item) -%}
  <td class="inventory-item-name">
    {{ item.name }}
    <dl>
      {%- for attr in item.keys()|sort -%}
        {% if attr.startswith('audio-') and attr.endswith('_download_filename') %}
          <div class="audio-track">
            {%- set name = attr.partition('_')[0] -%}
            <dt><a href="{{ guest_merch.inventory_url(item.id, name) }}">{{ item[attr] }}</a></dt>
            <dd>{{ inventory_audio(item, name) }}</dd>
          </div>
        {% endif %}
      {%- endfor -%}
    </dl>
  </td>
{%- endmacro %}

{% macro inventory_table_row(item) -%}
  {% set type = item.type|int %}
  <tr>
    <td class="inventory-item-type">{{ c.MERCH_TYPES[type] }}</td>
    {% if type == c.CD -%}
      {{ inventory_table_data_cd_name(item) }}
    {% else %}
      <td class="inventory-item-name">{{ item.name }}</td>
    {% endif %}
    <td class="inventory-item-price">${{ '{:.2f}'.format( item.price|float) }}</td>
    {% if type in [c.TSHIRT, c.APPAREL] -%}
      {{ inventory_table_data_apparel_quantity(item) }}
    {% else %}
      <td class="inventory-item-quantity" data-order="{{ item.quantity }}">{{ item.quantity }}</td>
    {% endif %}
    <td class="inventory-item-image">{{ inventory_image(item, class='') }}</td>
  </tr>
{%- endmacro %}

{% macro inventory_table() -%}
  {%- if guest_merch.selling_merch == c.ROCK_ISLAND and guest_merch.inventory -%}
    <div class="table-responsive">
      <table
          class="table table-hover datatable inventory-table"
          data-page-length="-1"
          data-searching="false"
          data-paging="false"
          data-info="false"
          data-auto-width="true"
          data-order="[[0,'asc'],[1,'asc'],[2,'asc']]"
          data-order-multi="true">
        <thead>
          <tr>
            <th class="inventory-item-type">Type</th>
            <th class="inventory-item-name">Name</th>
            <th class="inventory-item-price">Price</th>
            <th class="inventory-item-quantity">Quantity</th>
            <th class="inventory-item-image" data-orderable="false">Promo Picture</th>
          </tr>
        </thead>
        <tbody>
        {% for item in guest_merch.inventory -%}
          {{ inventory_table_row(item) }}
        {%- endfor %}
        </tbody>
      </table>
    </div>
  {%- elif caller -%}
    {%- if guest_merch.selling_merch != c.ROCK_ISLAND -%}
      {{ caller('This group is not using Rock Island services.') }}
    {%- else -%}
      {{ caller('This group has not uploaded any inventory.') }}
    {%- endif -%}
  {%- endif -%}
{%- endmacro %}
