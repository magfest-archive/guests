{% extends "base.html" %}{% set admin_area=True %}
{% block title %}Band Admin{% endblock %}
{% block content %}

<style>
h1 {
  margin-top: 20px;
  margin-bottom: 20px;
}

.dataTables_length .dataTables_addon {
  margin-left: 25px;
}
</style>

<h1>Bands and Other Groups <a class="btn btn-primary" href="add_band">Add a Band</a></h1>

<div class="table-responsive">
  <table id="group-table" class="datatable table table-striped" data-page-length="-1">
    <thead>
        <tr>
            <th>Group</th>
            {% if c.BAND_PANEL_DEADLINE %}<th>Panel</th>{% endif %}
            {% if c.BAND_BIO_DEADLINE %}<th>Bio Provided</th>{% endif %}
            {% if c.BAND_AGREEMENT_DEADLINE %}<th>Agreement Completed</th>{% endif %}
            {% if c.BAND_W9_DEADLINE %}<th>W9 Uploaded</th>{% endif %}
            {% if c.BAND_MERCH_DEADLINE %}<th>Merch</th>{% endif %}
            {% if c.BAND_CHARITY_DEADLINE %}<th>Charity</th>{% endif %}
            {% if c.BAND_BADGE_DEADLINE %}<th>Badges Claimed</th>{% endif %}
            {% if c.STAGE_AGREEMENT_DEADLINE %}<th>Stage Plans</th>{% endif %}
            <th>Band?</th>
        </tr>
    </thead>
    <tbody>
    {% for group in groups %}
        <tr id="{{ group.id }}" class="{{ group.band|yesno("band,nonband") }}">
            <td>
              <a href="../groups/form?id={{ group.id }}">{{ group.name }}</a>
              <span class="band_info">{% if group.band %}(<a href="band_info?id={{ group.band.id }}" class="text-nowrap">Band Info</a>){% endif %}</span>
            </td>
            {% if c.BAND_PANEL_DEADLINE %}<td>{{ group.band.panel.status if group.band else '' }}</td>{% endif %}
            {% if c.BAND_BIO_DEADLINE %}<td>{{ group.band.bio.status if group.band else '' }}</td>{% endif %}
            {% if c.BAND_AGREEMENT_DEADLINE %}<td>{{ group.band.info.status if group.band else '' }}</td>{% endif %}
            {% if c.BAND_W9_DEADLINE %}<td>
                {% if group.band and not group.band.payment %}Not Needed
                {% else %}{{ group.band.taxes.status|url_to_link("Yes", "_blank") if group.band else '' }}{% endif %}</td>{% endif %}
            {% if c.BAND_MERCH_DEADLINE %}<td>{{ group.band.merch.status if group.band else '' }}</td>{% endif %}
            {% if c.BAND_CHARITY_DEADLINE %}<td>{{ group.band.charity.status if group.band else '' }}</td>{% endif %}
            {% if c.BAND_BADGE_DEADLINE %}<td>{{ group.unregistered_badges ~ " Unclaimed" if group.unregistered_badges else "Yes" }}</td>{% endif %}
            {% if c.STAGE_AGREEMENT_DEADLINE %}<td>{{ group.band.stage_plot.status|url_to_link("Yes", "_blank") if group.band else '' }}</td>{% endif %}
            <td class="band">
                {% if group.band %}
                    <button class="btn btn-sm btn-danger btn-unmark" data-group_id="{{ group.id }}" data-group_name="{{ group.name }}">Unmark as Band</button>
                {% else %}
                    <button class="btn btn-sm btn-primary btn-mark" data-group_id="{{ group.id }}" data-group_name="{{ group.name }}">Mark as Band</button>
                {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<p><a href="everything">Export all band data as a CSV file</a></p>

<script>
    var markAsBand = function (groupId, groupName) {
        var $group = $('#' + groupId),
            $band = $group.find('.band'),
            $bandInfo = $group.find('.band_info'),
            $button = $band.find('.btn').prop('disabled', true).text('Marking...');
        $.ajax({
            method: 'POST',
            url: 'mark_as_band',
            data: {
                group_id: groupId,
                csrf_token: csrf_token
            },
            success: function (response) {
                if (response.id) {
                    $band.empty().append(
                        '<button class="btn btn-sm btn-danger btn-unmark" data-group_id="' + groupId + '" data-group_name="' + groupName + '">Unmark as Band</button>'
                    ).parents('tr').removeClass('nonband').addClass('band');
                    $bandInfo.empty().append(
                        '(<a href="band_info?id=' + response.id + '" class="text-nowrap">Band Info</a>)'
                    );
                }
                toastr.info(response.message);
            }
        });
    };

    var removeAsBand = function (groupId, groupName) {
        var $group = $('#' + groupId),
            $band = $group.find('.band'),
            $bandInfo = $group.find('.band_info'),
            $button = $band.find('.btn').prop('disabled', true).text('Unmarking...');
        $.ajax({
            method: 'POST',
            url: 'remove_as_band',
            data: {
                group_id: groupId,
                csrf_token: csrf_token
            },
            success: function (response) {
                if (response.id) {
                    $band.empty().append(
                        '<button class="btn btn-sm btn-primary btn-mark" data-group_id="' + groupId + '" data-group_name="' + groupName + '">Mark as Band</button>'
                    ).parents('tr').removeClass('band').addClass('nonband');
                    $bandInfo.empty();
                }
                toastr.info(response.message);
            }
        });
    };

    $(function() {
        $(window).load(function() {
            $('.dataTables_length').append(
                '<label class="dataTables_addon">' +
                '<input type="checkbox" id="only-bands" /> Show only bands' +
                '</label>');

            var $onlyBands = $('#only-bands').on('click', function () {
                setVisible('.nonband', !$onlyBands.prop('checked'))
            });
        });

        $('#group-table').on('click', '.btn-mark', function(event) {
            event.preventDefault();
            var groupId = $(this).data('group_id'),
                groupName = $(this).data('group_name');
            markAsBand(groupId, groupName);
        });

        $('#group-table').on('click', '.btn-unmark', function(event) {
            event.preventDefault();
            var groupId = $(this).data('group_id'),
                groupName = $(this).data('group_name');
            bootbox.confirm({
                backdrop: true,
                title: 'Unmark "' + groupName + '" as Band',
                message: 'Are you sure you want to unmark "' + groupName + '" as a band? This will permanently erase their bio info, stage layouts, agreements, etc...',
                buttons: {
                    confirm: { label: 'Unmark as Band', className: 'btn-danger' },
                    cancel: { label: 'Nevermind', className: 'btn-default' }
                },
                callback: function(result) {
                    if (result) {
                        removeAsBand(groupId, groupName);
                    }
                }
            });
        });
    });
</script>

{% endblock %}
